<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ Ping HÄ±zÄ± KarÅŸÄ±laÅŸtÄ±rma</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
   <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Ping HÄ±zÄ± KarÅŸÄ±laÅŸtÄ±rma AracÄ±</h1>
        
        <div class="server-status" id="serverStatus">
            <span>ğŸŒ Backend Durumu:</span>
            <span id="serverStatusText" class="server-offline">Kontrol ediliyor...</span>
        </div>
        
        <div class="controls">
            <div class="input-group">
                <label>ğŸ  LAN IP Adresi</label>
                <input type="text" id="lanIp" placeholder="192.168.1.1" value="192.168.1.1">
                <small>Router veya modem IP'si</small>
            </div>
            
            <div class="input-group">
                <label>ğŸŒ WAN Adresi</label>
                <input type="text" id="wanIp" placeholder="8.8.8.8" value="8.8.8.8">
                <small>Google DNS veya baÅŸka site</small>
            </div>
            
            <div class="input-group">
                <label>ğŸ“Š Test SayÄ±sÄ±</label>
                <input type="number" id="testCount" value="10" min="3" max="20">
                <button onclick="startRealPingTest()">GerÃ§ek Ping Testi</button>
            </div>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="stats-grid">
            <div class="stat-card lan-stat">
                <div class="stat-value" id="lanAvg">-</div>
                <div class="stat-label">ğŸ  LAN Ortalama (ms)</div>
            </div>
            <div class="stat-card wan-stat">
                <div class="stat-value" id="wanAvg">-</div>
                <div class="stat-label">ğŸŒ WAN Ortalama (ms)</div>
            </div>
            <div class="stat-card avg-stat">
                <div class="stat-value" id="speedDiff">-</div>
                <div class="stat-label">âš¡ HÄ±z FarkÄ± (kat)</div>
            </div>
            <div class="stat-card packet-loss">
                <div class="stat-value" id="packetLoss">-</div>
                <div class="stat-label">ğŸ“¦ Paket KaybÄ± (%)</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="pingChart"></canvas>
        </div>

        <div class="test-history">
            <h3>ğŸ“ Test GeÃ§miÅŸi:</h3>
            <div id="testLogs"></div>
        </div>

        <div class="tips">
            <h3>ğŸ’¡ Ä°puÃ§larÄ± ve Bilgiler</h3>
            <ul>
                <li><strong>GerÃ§ek Ping:</strong> Bu araÃ§ artÄ±k gerÃ§ek ping deÄŸerleri kullanÄ±yor!</li>
                <li><strong>LAN Ping:</strong> Yerel aÄŸÄ±nÄ±zdaki cihazlara ping sÃ¼resi (genellikle 1-5ms)</li>
                <li><strong>WAN Ping:</strong> Ä°nternet Ã¼zerindeki sunuculara ping sÃ¼resi (20-100ms+)</li>
                <li><strong>Backend API:</strong> Node.js sunucusu gerÃ§ek ping komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±yor</li>
                <li><strong>Paket KaybÄ±:</strong> %0 ideal, %5+ Ã¼stÃ¼ problem iÅŸareti</li>
            </ul>
        </div>
    </div>

    <script>
        let chart;
        let lanPings = [];
        let wanPings = [];
        let testLabels = [];
        const API_BASE = ''; // Same origin olduÄŸu iÃ§in boÅŸ

        // Backend durumunu kontrol et
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                document.getElementById('serverStatusText').textContent = 
                    `âœ… Online (Uptime: ${Math.floor(data.uptime)}s)`;
                document.getElementById('serverStatusText').className = 'server-online';
                
                addLog(`ğŸš€ Backend baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ± - Node ${data.node}`);
                return true;
            } catch (error) {
                document.getElementById('serverStatusText').textContent = 'âŒ Offline';
                document.getElementById('serverStatusText').className = 'server-offline';
                addLog(`âŒ Backend baÄŸlantÄ± hatasÄ±: ${error.message}`);
                return false;
            }
        }

        // GerÃ§ek ping API Ã§aÄŸrÄ±sÄ±
        async function realPing(host) {
            try {
                const response = await fetch(`/api/ping/${encodeURIComponent(host)}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Ping baÅŸarÄ±sÄ±z');
                }
                
                addLog(`ğŸ“ ${host}: ${data.time}ms (${data.alive ? 'BaÅŸarÄ±lÄ±' : 'BaÅŸarÄ±sÄ±z'})`);
                
                return {
                    time: data.alive ? data.time : null,
                    alive: data.alive,
                    host: data.host
                };
            } catch (error) {
                addLog(`âŒ ${host} ping hatasÄ±: ${error.message}`);
                return {
                    time: null,
                    alive: false,
                    host: host,
                    error: error.message
                };
            }
        }

        // Test loglarÄ±nÄ± ekle
        function addLog(message) {
            const logsContainer = document.getElementById('testLogs');
            const logElement = document.createElement('div');
            logElement.className = 'test-log';
            logElement.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logsContainer.appendChild(logElement);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function initChart() {
            const ctx = document.getElementById('pingChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ğŸ  LAN Ping (ms)',
                        data: [],
                        borderColor: '#4ECDC4',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'ğŸŒ WAN Ping (ms)',
                        data: [],
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'GerÃ§ek Ping SÃ¼releri KarÅŸÄ±laÅŸtÄ±rmasÄ±',
                            color: 'white',
                            font: { size: 18 }
                        },
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'white' }
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: { color: 'white' },
                            title: {
                                display: true,
                                text: 'Ping SÃ¼resi (ms)',
                                color: 'white'
                            }
                        }
                    }
                }
            });
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }

        function updateStats() {
            if (lanPings.length === 0) return;
            
            const lanSuccessful = lanPings.filter(p => p !== null);
            const wanSuccessful = wanPings.filter(p => p !== null);
            
            const lanAvg = lanSuccessful.length > 0 ? 
                lanSuccessful.reduce((a, b) => a + b, 0) / lanSuccessful.length : 0;
            const wanAvg = wanSuccessful.length > 0 ? 
                wanSuccessful.reduce((a, b) => a + b, 0) / wanSuccessful.length : 0;
            
            const speedDiff = lanAvg > 0 ? wanAvg / lanAvg : 0;
            
            // Paket kaybÄ± hesaplama
            const totalTests = lanPings.length + wanPings.length;
            const lostPackets = (lanPings.filter(p => p === null).length + 
                               wanPings.filter(p => p === null).length);
            const packetLoss = totalTests > 0 ? (lostPackets / totalTests) * 100 : 0;
            
            document.getElementById('lanAvg').textContent = lanAvg > 0 ? lanAvg.toFixed(1) : 'N/A';
            document.getElementById('wanAvg').textContent = wanAvg > 0 ? wanAvg.toFixed(1) : 'N/A';
            document.getElementById('speedDiff').textContent = speedDiff > 0 ? speedDiff.toFixed(1) + 'x' : 'N/A';
            document.getElementById('packetLoss').textContent = packetLoss.toFixed(1);
        }

        async function startRealPingTest() {
            const lanIp = document.getElementById('lanIp').value.trim();
            const wanIp = document.getElementById('wanIp').value.trim();
            const testCount = parseInt(document.getElementById('testCount').value);
            
            if (!lanIp || !wanIp) {
                updateStatus('LÃ¼tfen IP adreslerini girin!', 'error');
                return;
            }
            
            // Backend durumunu kontrol et
            const serverOnline = await checkServerStatus();
            if (!serverOnline) {
                updateStatus('âŒ Backend sunucusu Ã§alÄ±ÅŸmÄ±yor! LÃ¼tfen sunucuyu baÅŸlatÄ±n.', 'error');
                return;
            }
            
            // Reset data
            lanPings = [];
            wanPings = [];
            testLabels = [];
            
            const button = document.querySelector('button');
            button.disabled = true;
            button.innerHTML = 'GerÃ§ek Ping Testi Ã‡alÄ±ÅŸÄ±yor... <span class="ping-animation"></span>';
            
            updateStatus(`ğŸš€ GerÃ§ek ping testleri baÅŸlÄ±yor... ${testCount} test yapÄ±lacak`, 'testing');
            addLog(`ğŸ¯ Test baÅŸlÄ±yor: LAN=${lanIp}, WAN=${wanIp}, Count=${testCount}`);
            
            for (let i = 1; i <= testCount; i++) {
                updateStatus(`Test ${i}/${testCount} Ã§alÄ±ÅŸÄ±yor... (GerÃ§ek ping)`, 'testing');
                
                // Paralel ping testleri (gerÃ§ek API)
                const [lanResult, wanResult] = await Promise.all([
                    realPing(lanIp),
                    realPing(wanIp)
                ]);
                
                lanPings.push(lanResult.time);
                wanPings.push(wanResult.time);
                testLabels.push(`Test ${i}`);
                
                // Grafik gÃ¼ncelle - null deÄŸerleri 0 olarak gÃ¶ster
                const lanDisplayValue = lanResult.time !== null ? lanResult.time : 0;
                const wanDisplayValue = wanResult.time !== null ? wanResult.time : 0;
                
                chart.data.labels = [...testLabels];
                chart.data.datasets[0].data = lanPings.map(p => p !== null ? p : 0);
                chart.data.datasets[1].data = wanPings.map(p => p !== null ? p : 0);
                chart.update('none');
                
                // Ä°statistikleri gÃ¼ncelle
                updateStats();
                
                // KÃ¼Ã§Ã¼k bekleme (network'Ã¼ bombalamasÄ±n)
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            button.disabled = false;
            button.textContent = 'GerÃ§ek Ping Testi';
            
            const successfulTests = lanPings.filter(p => p !== null).length + 
                                  wanPings.filter(p => p !== null).length;
            const totalPossible = testCount * 2;
            
            updateStatus(`âœ… GerÃ§ek ping testi tamamlandÄ±! ${successfulTests}/${totalPossible} baÅŸarÄ±lÄ± ping.`, 'success');
            addLog(`ğŸ‰ Test tamamlandÄ±! BaÅŸarÄ± oranÄ±: ${((successfulTests/totalPossible)*100).toFixed(1)}%`);
        }

        // Sayfa yÃ¼klendiÄŸinde
        window.onload = async function() {
            initChart();
            addLog('ğŸŒŸ Ping KarÅŸÄ±laÅŸtÄ±rma AracÄ± baÅŸlatÄ±ldÄ±');
            
            // Backend durumunu kontrol et
            await checkServerStatus();
            
            setTimeout(() => {
                updateStatus('âœ… HazÄ±r! IP adreslerini kontrol edip "GerÃ§ek Ping Testi" butonuna tÄ±klayÄ±n.', 'success');
            }, 1000);
        };
    </script>
</body>
</html>